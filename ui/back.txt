 
    def display_message(self, username: str, content: str):
        """Display message with error handling."""
        try:
            is_own_message = username == self.username
            
            # Ensure theme_cls is not None
            theme_cls = self.app_theme_cls if hasattr(self, 'app_theme_cls') else self.theme_cls
            
            message_card = MessageCard(
                username=username,
                content=content,
                is_own_message=is_own_message,
                chat_width=getattr(self.chat_messages_layout, 'width', 400)
            )
            
            container = MessageContainer(message_card, is_own_message)
            self.chat_messages_layout.add_widget(container)
            Clock.schedule_once(lambda dt: self.smooth_scroll_to_bottom(), 0.15)
            
            # Animate user activity in sidebar
            if username != self.username:
                self.sidebar.animate_user_activity(username)
            
        except Exception as e:
            print(f"Message display error: {e}")